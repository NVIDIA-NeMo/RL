# Copyright (c) 2025, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Renovate

on:
  schedule:
    # Run daily at 5 PM UTC (9 AM PST / 10 AM PDT) to align with Renovate schedule
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      log_level:
        description: 'Renovate log level'
        required: false
        default: 'info'
        type: choice
        options:
          - debug
          - info
          - warn
          - error
      dry_run:
        description: 'Dry run (no PRs created)'
        required: false
        default: false
        type: boolean

jobs:
  renovate:
    name: Renovate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "0.9.1"
          enable-cache: true
          prune-cache: false

      - name: Make scripts executable
        run: |
          chmod +x .github/scripts/sync_submodule_dependencies.py
          chmod +x .github/scripts/renovate_post_update.sh

      - name: Pre-clone repository with full submodule history
        env:
          RENOVATE_TOKEN: ${{ secrets.RENOVATE_TOKEN }}
        run: |
          # Pre-clone the repo to where Renovate expects it, with unshallowed submodules
          # Renovate will reuse this clone instead of cloning fresh
          CLONE_DIR="/tmp/renovate/repos/github/${{ github.repository_owner }}/${{ github.event.repository.name }}"
          mkdir -p "$(dirname "$CLONE_DIR")"
          
          echo "Cloning to $CLONE_DIR with full submodule history..."
          git clone --recurse-submodules \
            "https://x-access-token:${RENOVATE_TOKEN}@github.com/${{ github.repository }}.git" \
            "$CLONE_DIR"
          
          cd "$CLONE_DIR"
          
          # Unshallow all submodules (they were cloned shallow due to .gitmodules setting)
          echo "Unshallowing submodules..."
          git submodule foreach --recursive 'git fetch --unshallow origin 2>/dev/null || echo "Already unshallow or no remote"'
          
          echo ""
          echo "Submodule status:"
          git submodule status --recursive
          
          # Fix permissions for Renovate container (runs as uid 1000)
          chmod -R a+rwX /tmp/renovate
          
          # Create global gitconfig for Renovate container to mark this as a safe directory
          # This is needed because the repo was created by the runner user but Renovate
          # runs as a different user inside its Docker container
          mkdir -p /tmp/renovate/cache
          cat > /tmp/renovate/cache/.gitconfig << EOF
          [safe]
              directory = /tmp/renovate/repos/github/${{ github.repository_owner }}/${{ github.event.repository.name }}
              directory = *
          EOF
          chmod a+r /tmp/renovate/cache/.gitconfig

      # Option 1: Use GitHub App token (recommended for better rate limits)
      # Requires RENOVATE_APP_ID and RENOVATE_APP_PRIVATE_KEY secrets
      # If these secrets aren't set, this step will be skipped and PAT will be used
      - name: Get GitHub App token
        id: get-app-token
        continue-on-error: true
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RENOVATE_APP_ID }}
          private-key: ${{ secrets.RENOVATE_APP_PRIVATE_KEY }}

      - name: Run Renovate
        uses: renovatebot/github-action@v44.0.3
        with:
          configurationFile: .github/renovate.json
          # Use GitHub App token if available, otherwise fall back to PAT
          token: ${{ steps.get-app-token.outputs.token || secrets.RENOVATE_TOKEN }}
        env:
          LOG_LEVEL: ${{ inputs.log_level || 'info' }}
          RENOVATE_DRY_RUN: ${{ inputs.dry_run || false }}
          # Explicitly set which repository to process
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          # Global-only configuration options
          RENOVATE_ONBOARDING: 'false'
          RENOVATE_REQUIRE_CONFIG: 'optional'
          RENOVATE_ALLOWED_POST_UPGRADE_COMMANDS: '["^\\.github/scripts/renovate_post_update\\.sh$"]'
          # Use our custom gitconfig that marks the pre-cloned repo as safe
          GIT_CONFIG_GLOBAL: /tmp/renovate/cache/.gitconfig

